<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Site Notes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
.container { max-width: 900px; margin: 0 auto; padding: 16px; }
h1 { font-size: 1.5rem; margin-bottom: 16px; color: #333; }
.tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; width: 100%; }
.tab-btn { flex: 1; }
.tab-btn { padding: 10px 20px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 6px; font-size: 14px; }
.tab-btn.active { background: #2196F3; color: white; }
.tab-content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.tab-content.active { display: block; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; }
.form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
.form-group textarea { min-height: 330px; resize: vertical; font-family: inherit; }
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
.checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; }
.quick-add-section { margin-bottom: 16px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; width: 100%; }
.section-header { background: #f5f5f5; padding: 12px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; user-select: none; }
.section-header:hover { background: #e8e8e8; }
.section-arrow { transition: transform 0.3s; font-size: 12px; }
.section-arrow.collapsed { transform: rotate(-90deg); }
.section-content { padding: 16px; display: none; }
.section-content.active { display: block; }
.checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9f9f9; border-radius: 6px; }
.checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.checkbox-item label { cursor: pointer; font-size: 14px; flex: 1; }
.photo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px; }
.photo-slot { border: 2px dashed #ddd; border-radius: 8px; padding: 16px; text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
.photo-slot.has-photo { border-style: solid; border-color: #2196F3; }
.photo-slot img { max-width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 10px; border-radius: 4px; }
.photo-slot input[type="file"] { display: none; }
.photo-slot .add-btn { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; }
.photo-slot .remove-btn { padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px; }
.photo-slot input[type="text"] { margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
.btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
.btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
.btn-primary { background: #2196F3; color: white; }
.btn-success { background: #4CAF50; color: white; }
.btn-secondary { background: #757575; color: white; }
.btn-danger { background: #f44336; color: white; }
.settings-section { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #eee; }
.settings-section h3 { margin-bottom: 16px; color: #333; }
.template-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
.template-item input { flex: 1; }
.template-item span { min-width: 30px; color: #666; }
.logo-preview { max-width: 200px; max-height: 100px; margin-top: 10px; }
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
th { background: #f5f5f5; font-weight: 600; }
tr:hover { background: #f9f9f9; }
.clickable { cursor: pointer; color: #2196F3; }
.note-preview { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #666; font-size: 13px; }
.action-btns { display: flex; gap: 6px; }
.action-btns .btn { padding: 6px 12px; font-size: 12px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
.modal.active { display: flex; }
.modal-content { background: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%; }
.modal-content h3 { margin-bottom: 16px; }
.modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
.search-dropdown { position: relative; width: 100%; }
.search-dropdown input { width: 100%; }
.dropdown-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 6px 6px; max-height: 250px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.dropdown-list.active { display: block; }
.dropdown-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
.dropdown-item:hover { background: #f5f5f5; }
.dropdown-item.add-new { color: #2196F3; font-weight: 500; border-top: 2px solid #ddd; }
.dropdown-item.no-results { color: #999; cursor: default; }
.dropdown-item.no-results:hover { background: white; }
@media (max-width: 600px) {
  .form-row { grid-template-columns: 1fr; }
  .checkbox-grid { grid-template-columns: 1fr; }
  .photo-grid { grid-template-columns: 1fr; }
  table { font-size: 13px; }
  th, td { padding: 8px 4px; }
}
</style>
</head>
<body>
<div class="container">
<h1>üìã Site Notes</h1>
<div class="tabs">
<button class="tab-btn active" onclick="showTab('new')">Edit Note</button>
<button class="tab-btn" onclick="showTab('saved')">Saved Notes</button>
<button class="tab-btn" onclick="showTab('jobs')">Jobs</button>
<button class="tab-btn" onclick="showTab('settings')">Settings</button>
</div>

<div id="new" class="tab-content active">
<div class="form-row">
<div class="form-group">
  <label>Job Name</label>
  <div class="search-dropdown">
    <input type="text" id="jobName" placeholder="Search or select job..." autocomplete="off" onkeyup="filterJobs()" onfocus="showJobDropdown()" onblur="hideJobDropdown()">
    <div class="dropdown-list" id="jobDropdown"></div>
  </div>
</div>
<div class="form-group"><label>Job Number</label><input type="text" id="jobNumber"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Client</label><input type="text" id="client"></div>
<div class="form-group"><label>BC Number</label><input type="text" id="bcNumber"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Weather</label><input type="text" id="weather"></div>  
<div class="form-group"><label>Site Foreman</label><input type="text" id="siteForeman"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Technician</label><input type="text" id="technician"></div>
<div class="form-group"><label>Date</label><input type="date" id="noteDate"></div>
<div class="form-group"><label>Time</label><input type="time" id="noteTime"></div>
</div>

<h3 style="margin: 20px 0 12px;">Quick Add Items</h3>
<div id="checkboxGrid"></div>

<div class="form-group">
<label>Site Notes</label>
<textarea id="siteNotes" placeholder="Enter your site notes here..."></textarea>
</div>

<h3 style="margin: 20px 0 12px;">Photos (max 6)</h3>
<div class="photo-grid" id="photoGrid"></div>

<div class="btn-group">
<button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
<button class="btn btn-secondary" onclick="exportTXT()">üìù Export TXT</button>
<button class="btn btn-secondary" onclick="exportDOC()">üìÑ Export Word</button>
<button class="btn btn-success" onclick="saveAndClose()">üíæ Save & Close</button>
</div>
</div>

<div id="saved" class="tab-content">
<h2 style="margin-bottom: 16px;">Saved Notes</h2>
<div id="savedNotesTable"></div>
<div class="btn-group" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
<button class="btn btn-primary" onclick="exportAllData()">üì§ Export All Data</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import Data</button>
<input type="file" id="importFile" accept=".json" style="display:none;" onchange="importAllData(event)">
</div>
</div>

<div id="jobs" class="tab-content">
<h2 style="margin-bottom: 16px;">Job Database</h2>
<button class="btn btn-success" style="margin-bottom: 20px;" onclick="showAddJobModal()">+ Add New Job</button>
<div id="jobsTable"></div>
</div>

<div id="settings" class="tab-content">
<div class="settings-section">
<h3>Technician Name</h3>
<div class="form-group">
<input type="text" id="settingsTechnician" placeholder="Enter default technician name" onchange="saveSettings()">
</div>
</div>

<div class="settings-section">
<h3>Company Logo</h3>
<div class="form-group">
<input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
<img id="logoPreview" class="logo-preview" style="display:none;">
<br><button class="btn btn-danger" style="margin-top:10px;" onclick="removeLogo()">Remove Logo</button>
</div>
</div>

<div class="settings-section">
<h3>Quick Add Templates</h3>
<div id="templateInputs"></div>
<button class="btn btn-success" style="margin-top:10px;" onclick="saveSettings()">Save Templates</button>
</div>
</div>
</div>

<div class="modal" id="deleteModal">
<div class="modal-content">
<h3>Delete Note?</h3>
<p>Are you sure you want to delete this note? This cannot be undone.</p>
<div class="modal-btns">
<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
<button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
</div>
</div>
</div>

<div class="modal" id="jobModal">
<div class="modal-content">
<h3 id="jobModalTitle">Add New Job</h3>
<div class="form-group">
  <label>Job Name *</label>
  <input type="text" id="modalJobName" placeholder="Enter job name">
</div>
<div class="form-group">
  <label>Job Number *</label>
  <input type="text" id="modalJobNumber" placeholder="Enter job number">
</div>
<div class="form-group">
  <label>Client</label>
  <input type="text" id="modalClient" placeholder="Enter client name">
</div>
<div class="form-group">
  <label>BC Number</label>
  <input type="text" id="modalBcNumber" placeholder="Enter BC number">
</div>
<div class="form-group">
  <label>Site Foreman</label>
  <input type="text" id="modalSiteForeman" placeholder="Enter site foreman name">
</div>
<div class="modal-btns">
  <button class="btn btn-secondary" onclick="closeJobModal()">Cancel</button>
  <button class="btn btn-success" onclick="saveJob()">Save Job</button>
</div>
</div>
</div>

<div class="modal" id="deleteJobModal">
<div class="modal-content">
<h3>Delete Job?</h3>
<p>Are you sure you want to delete this job? This cannot be undone.</p>
<div class="modal-btns">
  <button class="btn btn-secondary" onclick="closeDeleteJobModal()">Cancel</button>
  <button class="btn btn-danger" onclick="confirmDeleteJob()">Delete</button>
</div>
</div>
</div>

<script>
const defaultTemplates = {
  earthworks: [
    { title: "Site Stripping", text: "Observed topsoil stripping across approximate area shown on attached site plan. Topsoil had adequately been stripped with native soils exposed" },
    { title: "Proof Roll (passed)", text: "Observed proof roll of the area shown on the attached site plan with a XX ton smooth drum roller. No obvious deflections were visible. Vane shear strengths measured across the area ranged between XX and XX kPa. Advised contractor that basecourse could be placed across this area." },
    { title: "Proof Roll (failed)", text: "Observed proof roll of the area shown on the attached site plan with a XX ton smooth drum roller. Weaving of the ground was identified in the areas shown on site plan. Trial pits were carried out in these areas to a depth of XX m which identified ..." },
    { title: "Clay Fill Testing", text: "Approximately XXX mm of clay has been placed across the fill area shown on the attached site plan since last visit. Shear vane testing across the fill area ranged from XX to XX kPa. XX air voids samples were collected from locations shown on attached site plan." },
    { title: "Clegg Testing", text: "Approximately XXX mm of hardfill has been placed across the area shown on the attached site plan since last visit. Clegg Hammer testing was carried out which returned CIV values ranging between XX and XX which meet the required specification." },
    { title: "Hardfill NDM Testing", text: "Approximately XXX mm of hardfill has been placed across the area shown on the attached site plan since last visit. XXX NDM tests were carried out in the locations shown on the site plan. These returned results ranging between XX and XX % of MDD which meet the required specification." },
    { title: "Retaining Walls", text: "Observed the retaining wall pile holes along the length marked on the attached plan. Pile hole depths ranged between XX and XX m. Shear vanes in the cut face ranged between XX and XX kPa. Shear vanes in the pile holes ranged between XX and XX kPa." },
    { title: "Cut Batter Inspection", text: "Observed cut batters along the alignment shown on the attached site plan. Cut batters were excavated to a maximum depth of XX m. Shear vane testing in the cut face ranged between XX and XX kPa which meets the design assumptions." },
    { title: "Drainage Installation", text: "Observed installation of drainage across the area shown on the attached site plan. Drainage pipes were installed at depths ranging from XX to XX m below finished ground level. Pipe bedding material was adequately compacted." },
    { title: "Aggregate Pier Installation", text: "Observed installation of aggregate piers at locations shown on attached site plan. Piers were installed to depths ranging from XX to XX m. Pier diameters ranged from XXX to XXX mm. Compaction energy met specification requirements." }
  ],
  building: [
    { title: "Shallow Foundations", text: "Observed strip and pad foundation excavations along the grid lines marked on the attached site plan. All excavations were a minimum of XXX mm deep. Shear vanes in the base ranged between XX and XX kPa which meet the design assumptions." },
    { title: "Piled Foundations", text: "Observed bored pile excavations as shown on attached site plan. Piles were XX m deep and XXX mm diameter. Shear vanes in the side of the piles ranged between XX and XX kPa and in the base ranged between XX and XX kPa which meet the design assumptions." },
    { title: "Slab on Grade Preparation", text: "Observed preparation of slab on grade subgrade across the area shown on attached site plan. Subgrade was proof rolled and showed no deflections. Shear vane testing ranged from XX to XX kPa. Vapor barrier and reinforcing mesh were installed as per specification." },
    { title: "Concrete Pour", text: "Observed concrete pour for [foundation/slab/wall] as shown on attached site plan. Concrete was placed in accordance with specification. Slump test results were XX mm. Concrete samples were taken for compression testing." },
    { title: "Masonry Wall Construction", text: "Observed construction of masonry walls along grid lines shown on attached site plan. Masonry units were laid in accordance with specification. Mortar joints were properly tooled. Wall ties and reinforcement installed as per drawings." },
    { title: "Structural Steel Erection", text: "Observed erection of structural steel members as shown on attached site plan. All connections were made in accordance with specifications. Bolts were torqued to required values. Alignment and plumbness were within tolerance." },
    { title: "Timber Framing", text: "Observed timber framing construction as shown on attached site plan. All timber members met grade requirements. Connections were made in accordance with specifications. Bracing and hold-downs installed as per drawings." },
    { title: "Waterproofing Application", text: "Observed application of waterproofing membrane to [foundation walls/slab] as shown on attached site plan. Surface preparation was adequate. Membrane application followed manufacturer specifications. All joints and penetrations properly sealed." },
    { title: "Backfill Operations", text: "Observed backfilling operations around [foundations/retaining walls] as shown on attached site plan. Backfill material met specification requirements. Material was placed in XXX mm lifts and compacted. No damage observed to waterproofing." },
    { title: "Floor System Installation", text: "Observed installation of floor system as shown on attached site plan. All components met specification requirements. Installation followed manufacturer recommendations. Adequate bearing and support provided at all locations." }
  ],
  other: [
    { title: "Follow up with CAN", text: "Discussed potential remedial actions with contractor. Our recommendations will be issued in a separate CAN." },
    { title: "Materials Testing", text: "Collected XX samples from locations shown on attached site plan. Samples will be tested at our laboratory for [specify tests]. Results will be provided in separate correspondence." },
    { title: "Survey Control", text: "Verified survey control points as shown on attached site plan. All elevations were within tolerance of design levels. Offset stakes were installed at locations shown on plan." },
    { title: "Pre-construction Meeting", text: "Attended pre-construction meeting with [attendees]. Discussed project scope, timeline, and key requirements. Action items were assigned and documented." },
    { title: "Progress Inspection", text: "General site inspection conducted. Work is progressing in accordance with project schedule. No significant issues observed. Contractor continues to follow approved construction methodology." },
    { title: "Safety Observation", text: "Site safety conditions observed. [Adequate safety measures in place / Safety concerns noted and discussed with site foreman]. Recommended [any corrective actions if applicable]." }
  ]
};

let settings = JSON.parse(localStorage.getItem('siteNotesSettings')) || {
  technician: '',
  logo: null,
  templates: {
    earthworks: [...defaultTemplates.earthworks],
    building: [...defaultTemplates.building],
    other: [...defaultTemplates.other]
  }
};
let savedNotes = JSON.parse(localStorage.getItem('siteNotesSaved')) || [];
let savedJobs = JSON.parse(localStorage.getItem('siteNotesJobs')) || [];
let photos = [null, null, null, null, null, null];
let editingNoteId = null;
let deleteNoteId = null;
let editingJobId = null;
let deleteJobId = null;

function init() {
  document.getElementById('settingsTechnician').value = settings.technician;
  if (settings.logo) {
    document.getElementById('logoPreview').src = settings.logo;
    document.getElementById('logoPreview').style.display = 'block';
  }
  renderTemplateInputs();
  renderCheckboxes();
  renderPhotoSlots();
  renderSavedNotes();
  setDefaultDateTime();
  document.getElementById('technician').value = settings.technician;
  renderJobs();
}

function setDefaultDateTime() {
  const now = new Date();
  document.getElementById('noteDate').value = now.toISOString().split('T')[0];
  document.getElementById('noteTime').value = now.toTimeString().slice(0,5);
}

function showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(tab).classList.add('active');
  if (tab === 'saved') renderSavedNotes();
}

function renderTemplateInputs() {
  const container = document.getElementById('templateInputs');
  
  let html = '';
  
  // Earthworks section
  html += '<div class="settings-section"><h3>Earthworks Templates (10)</h3>';
  html += settings.templates.earthworks.map((t, i) => `
    <div class="template-item" style="flex-direction:column;align-items:stretch;margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:6px;">
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <span style="min-width:30px;">${i + 1}.</span>
        <input type="text" value="${t.title}" placeholder="Title" onchange="updateTemplate('earthworks', ${i}, 'title', this.value)">
      </div>
      <textarea style="width:100%;min-height:60px;margin-left:40px;width:calc(100% - 40px);" placeholder="Standard text..." onchange="updateTemplate('earthworks', ${i}, 'text', this.value)">${t.text}</textarea>
    </div>
  `).join('');
  html += '</div>';
  
  // Building Construction section
  html += '<div class="settings-section"><h3>Building Construction Templates (10)</h3>';
  html += settings.templates.building.map((t, i) => `
    <div class="template-item" style="flex-direction:column;align-items:stretch;margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:6px;">
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <span style="min-width:30px;">${i + 1}.</span>
        <input type="text" value="${t.title}" placeholder="Title" onchange="updateTemplate('building', ${i}, 'title', this.value)">
      </div>
      <textarea style="width:100%;min-height:60px;margin-left:40px;width:calc(100% - 40px);" placeholder="Standard text..." onchange="updateTemplate('building', ${i}, 'text', this.value)">${t.text}</textarea>
    </div>
  `).join('');
  html += '</div>';
  
  // Other section
  html += '<div class="settings-section"><h3>Other Templates (6)</h3>';
  html += settings.templates.other.map((t, i) => `
    <div class="template-item" style="flex-direction:column;align-items:stretch;margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:6px;">
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <span style="min-width:30px;">${i + 1}.</span>
        <input type="text" value="${t.title}" placeholder="Title" onchange="updateTemplate('other', ${i}, 'title', this.value)">
      </div>
      <textarea style="width:100%;min-height:60px;margin-left:40px;width:calc(100% - 40px);" placeholder="Standard text..." onchange="updateTemplate('other', ${i}, 'text', this.value)">${t.text}</textarea>
    </div>
  `).join('');
  html += '</div>';
  
  container.innerHTML = html;
}

function updateTemplate(category, index, field, value) {
  settings.templates[category][index][field] = value;
}

function renderCheckboxes() {
  const container = document.getElementById('checkboxGrid');
  
  let html = '';
  
  // Earthworks section
  html += `
    <div class="quick-add-section">
      <div class="section-header" onclick="toggleSection('earthworks')">
        <span>Earthworks</span>
        <span class="section-arrow" id="arrow-earthworks">‚ñº</span>
      </div>
      <div class="section-content" id="content-earthworks">
        <div class="checkbox-grid">
          ${settings.templates.earthworks.map((t, i) => `
            <div class="checkbox-item">
              <input type="checkbox" id="cb-earthworks-${i}" onchange="handleCheckbox('earthworks', ${i}, this.checked)">
              <label for="cb-earthworks-${i}">${t.title}</label>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  // Building Construction section
  html += `
    <div class="quick-add-section">
      <div class="section-header" onclick="toggleSection('building')">
        <span>Building Construction</span>
        <span class="section-arrow" id="arrow-building">‚ñº</span>
      </div>
      <div class="section-content" id="content-building">
        <div class="checkbox-grid">
          ${settings.templates.building.map((t, i) => `
            <div class="checkbox-item">
              <input type="checkbox" id="cb-building-${i}" onchange="handleCheckbox('building', ${i}, this.checked)">
              <label for="cb-building-${i}">${t.title}</label>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  // Other section
  html += `
    <div class="quick-add-section">
      <div class="section-header" onclick="toggleSection('other')">
        <span>Other</span>
        <span class="section-arrow" id="arrow-other">‚ñº</span>
      </div>
      <div class="section-content" id="content-other">
        <div class="checkbox-grid">
          ${settings.templates.other.map((t, i) => `
            <div class="checkbox-item">
              <input type="checkbox" id="cb-other-${i}" onchange="handleCheckbox('other', ${i}, this.checked)">
              <label for="cb-other-${i}">${t.title}</label>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

function toggleSection(section) {
  const content = document.getElementById('content-' + section);
  const arrow = document.getElementById('arrow-' + section);
  
  content.classList.toggle('active');
  arrow.classList.toggle('collapsed');
}

function handleCheckbox(category, index, checked) {
  if (checked) {
    const textarea = document.getElementById('siteNotes');
    const currentText = textarea.value;
    const newText = settings.templates[category][index].text;
    textarea.value = currentText ? currentText + '\n\n' + newText : newText;
  }
}

function renderPhotoSlots() {
  const container = document.getElementById('photoGrid');
  container.innerHTML = photos.map((p, i) => `
    <div class="photo-slot ${p ? 'has-photo' : ''}" id="slot${i}">
      ${p ? `<img src="${p.data}" alt="Photo ${i + 1}">` : ''}
      <input type="file" id="file${i}" accept="image/*" onchange="handlePhoto(${i}, event)">
      ${p ? '' : `<button class="add-btn" onclick="document.getElementById('file${i}').click()">+ Add Photo</button>`}
      ${p ? `<input type="text" placeholder="Caption..." value="${p.caption || ''}" onchange="updateCaption(${i}, this.value)">` : ''}
      ${p ? `<button class="remove-btn" onclick="removePhoto(${i})">Remove</button>` : ''}
    </div>
  `).join('');
}

function handlePhoto(index, event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > 1200) { h = h * (1200 / w); w = 1200; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      photos[index] = { data: canvas.toDataURL('image/jpeg', 0.85), caption: '' };
      renderPhotoSlots();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function updateCaption(index, caption) {
  if (photos[index]) photos[index].caption = caption;
}

function removePhoto(index) {
  photos[index] = null;
  renderPhotoSlots();
}

function handleLogoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 500000) { alert('Logo must be under 500KB'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    settings.logo = e.target.result;
    document.getElementById('logoPreview').src = settings.logo;
    document.getElementById('logoPreview').style.display = 'block';
    saveSettings();
  };
  reader.readAsDataURL(file);
}

function removeLogo() {
  settings.logo = null;
  document.getElementById('logoPreview').style.display = 'none';
  document.getElementById('logoInput').value = '';
  saveSettings();
}

function saveSettings() {
  settings.technician = document.getElementById('settingsTechnician').value;
  
  // Read earthworks templates
  document.querySelectorAll('#templateInputs .settings-section')[0].querySelectorAll('.template-item').forEach((item, i) => {
    const titleInput = item.querySelector('input[type="text"]');
    const textArea = item.querySelector('textarea');
    settings.templates.earthworks[i] = {
      title: titleInput.value,
      text: textArea.value
    };
  });
  
  // Read building templates
  document.querySelectorAll('#templateInputs .settings-section')[1].querySelectorAll('.template-item').forEach((item, i) => {
    const titleInput = item.querySelector('input[type="text"]');
    const textArea = item.querySelector('textarea');
    settings.templates.building[i] = {
      title: titleInput.value,
      text: textArea.value
    };
  });
  
  // Read other templates
  document.querySelectorAll('#templateInputs .settings-section')[2].querySelectorAll('.template-item').forEach((item, i) => {
    const titleInput = item.querySelector('input[type="text"]');
    const textArea = item.querySelector('textarea');
    settings.templates.other[i] = {
      title: titleInput.value,
      text: textArea.value
    };
  });
  
  localStorage.setItem('siteNotesSettings', JSON.stringify(settings));
  renderCheckboxes();
}

function getFormData() {
  return {
    id: editingNoteId || Date.now(),
    jobName: document.getElementById('jobName').value,
    jobNumber: document.getElementById('jobNumber').value,
    client: document.getElementById('client').value,
    bcNumber: document.getElementById('bcNumber').value,
    siteForeman: document.getElementById('siteForeman').value,
    weather: document.getElementById('weather').value,
    technician: document.getElementById('technician').value,
    date: document.getElementById('noteDate').value,
    time: document.getElementById('noteTime').value,
    notes: document.getElementById('siteNotes').value,
    photos: photos.filter(p => p !== null)
  };
}

function saveNote() {
  const data = getFormData();
  if (!data.jobName && !data.notes) { alert('Please add some content before saving.'); return; }
  const existingIndex = savedNotes.findIndex(n => n.id === data.id);
  if (existingIndex >= 0) savedNotes[existingIndex] = data;
  else savedNotes.unshift(data);
  localStorage.setItem('siteNotesSaved', JSON.stringify(savedNotes));
  alert('Note saved successfully!');
  editingNoteId = data.id;
}

function saveAndClose() {
  const data = getFormData();
  if (!data.jobName && !data.notes) { 
    alert('Please add some content before saving.'); 
    return; 
  }
  
  const existingIndex = savedNotes.findIndex(n => n.id === data.id);
  if (existingIndex >= 0) savedNotes[existingIndex] = data;
  else savedNotes.unshift(data);
  localStorage.setItem('siteNotesSaved', JSON.stringify(savedNotes));
  
  alert('Note saved successfully!');
  clearForm();
}

function renderSavedNotes() {
  const container = document.getElementById('savedNotesTable');
  if (savedNotes.length === 0) {
    container.innerHTML = '<p style="color:#666;">No saved notes yet.</p>';
    return;
  }
  
  // Check if we're on a mobile device (screen width < 720px)
  const isMobile = window.innerWidth < 720;
  
  if (isMobile) {
    // Mobile layout - only Date, Job Name, Actions
    container.innerHTML = `<table>
      <thead><tr><th>Date</th><th>Job Name</th><th>Actions</th></tr></thead>
      <tbody>${savedNotes.map(n => `
        <tr>
          <td>${n.date || '-'}</td>
          <td class="clickable" onclick="loadNote(${n.id})">${n.jobName || '-'}</td>
          <td class="action-btns">
            <button class="btn btn-primary" onclick="loadNote(${n.id})">Edit</button>
            <button class="btn btn-danger" onclick="showDeleteModal(${n.id})">Delete</button>
          </td>
        </tr>
      `).join('')}</tbody>
    </table>`;
  } else {
    // Desktop layout - all columns
    container.innerHTML = `<table>
      <thead><tr><th>Date</th><th>Job Number</th><th>Job Name</th><th>Preview</th><th>Actions</th></tr></thead>
      <tbody>${savedNotes.map(n => `
        <tr>
          <td>${n.date || '-'}</td>
          <td>${n.jobNumber || '-'}</td>
          <td class="clickable" onclick="loadNote(${n.id})">${n.jobName || '-'}</td>
          <td class="note-preview">${n.notes ? n.notes.substring(0, 50) : '-'}</td>
          <td class="action-btns">
            <button class="btn btn-primary" onclick="loadNote(${n.id})">Edit</button>
            <button class="btn btn-danger" onclick="showDeleteModal(${n.id})">Delete</button>
          </td>
        </tr>
      `).join('')}</tbody>
    </table>`;
  }
}

function loadNote(id) {
  const note = savedNotes.find(n => n.id === id);
  if (!note) return;
  editingNoteId = id;
  document.getElementById('jobName').value = note.jobName || '';
  document.getElementById('jobNumber').value = note.jobNumber || '';
  document.getElementById('client').value = note.client || '';
  document.getElementById('bcNumber').value = note.bcNumber || '';
  document.getElementById('siteForeman').value = note.siteForeman || '';
  document.getElementById('weather').value = note.weather || '';
  document.getElementById('technician').value = note.technician || '';
  document.getElementById('noteDate').value = note.date || '';
  document.getElementById('noteTime').value = note.time || '';
  document.getElementById('siteNotes').value = note.notes || '';
  photos = [null, null, null, null, null, null];
  (note.photos || []).forEach((p, i) => { if (i < 6) photos[i] = p; });
  renderPhotoSlots();
  showTab('new');
}

function showDeleteModal(id) {
  deleteNoteId = id;
  document.getElementById('deleteModal').classList.add('active');
}

function closeModal() {
  document.getElementById('deleteModal').classList.remove('active');
  deleteNoteId = null;
}

function confirmDelete() {
  savedNotes = savedNotes.filter(n => n.id !== deleteNoteId);
  localStorage.setItem('siteNotesSaved', JSON.stringify(savedNotes));
  closeModal();
  renderSavedNotes();
}

function clearForm() {
  editingNoteId = null;
  document.getElementById('jobName').value = '';
  document.getElementById('jobNumber').value = '';
  document.getElementById('client').value = '';
  document.getElementById('bcNumber').value = '';
  document.getElementById('siteForeman').value = '';
  document.getElementById('weather').value = '';
  document.getElementById('technician').value = settings.technician;
  document.getElementById('siteNotes').value = '';
  photos = [null, null, null, null, null, null];
  document.querySelectorAll('.checkbox-item input').forEach(cb => cb.checked = false);
  renderPhotoSlots();
  setDefaultDateTime();
}

// ============================================================================
// JOB MANAGEMENT FUNCTIONS
// ============================================================================

function renderJobs() {
  const container = document.getElementById('jobsTable');
  if (savedJobs.length === 0) {
    container.innerHTML = '<p style="color:#666;">No jobs saved yet.</p>';
    return;
  }
  
  // Sort by job number for display in table
  const sortedJobs = [...savedJobs].sort((a, b) => {
    const numA = a.jobNumber || '';
    const numB = b.jobNumber || '';
    return numA.localeCompare(numB, undefined, { numeric: true });
  });
  
  container.innerHTML = `<table>
    <thead><tr><th>Job Number</th><th>Job Name</th><th>Actions</th></tr></thead>
    <tbody>${sortedJobs.map(j => `
      <tr>
        <td>${j.jobNumber || '-'}</td>
        <td>${j.jobName || '-'}</td>
        <td class="action-btns">
          <button class="btn btn-primary" onclick="showEditJobModal(${j.id})">Edit</button>
          <button class="btn btn-danger" onclick="showDeleteJobModal(${j.id})">Delete</button>
        </td>
      </tr>
    `).join('')}</tbody>
  </table>`;
}

function showAddJobModal() {
  editingJobId = null;
  document.getElementById('jobModalTitle').textContent = 'Add New Job';
  document.getElementById('modalJobName').value = '';
  document.getElementById('modalJobNumber').value = '';
  document.getElementById('modalClient').value = '';
  document.getElementById('modalBcNumber').value = '';
  document.getElementById('modalSiteForeman').value = '';
  document.getElementById('jobModal').classList.add('active');
}

function showEditJobModal(id) {
  const job = savedJobs.find(j => j.id === id);
  if (!job) return;
  
  editingJobId = id;
  document.getElementById('jobModalTitle').textContent = 'Edit Job';
  document.getElementById('modalJobName').value = job.jobName || '';
  document.getElementById('modalJobNumber').value = job.jobNumber || '';
  document.getElementById('modalClient').value = job.client || '';
  document.getElementById('modalBcNumber').value = job.bcNumber || '';
  document.getElementById('modalSiteForeman').value = job.siteForeman || '';
  document.getElementById('jobModal').classList.add('active');
}

function closeJobModal() {
  document.getElementById('jobModal').classList.remove('active');
  editingJobId = null;
}

function saveJob() {
  const jobName = document.getElementById('modalJobName').value.trim();
  const jobNumber = document.getElementById('modalJobNumber').value.trim();
  const client = document.getElementById('modalClient').value.trim();
  const bcNumber = document.getElementById('modalBcNumber').value.trim();
  const siteForeman = document.getElementById('modalSiteForeman').value.trim();
  
  // Validation
  if (!jobName || !jobNumber) {
    alert('Job Name and Job Number are required.');
    return;
  }
  
  // Check for duplicate job number (exclude current job if editing)
  const duplicate = savedJobs.find(j => 
    j.jobNumber === jobNumber && j.id !== editingJobId
  );
  
  if (duplicate) {
    alert('A job with this Job Number already exists. Please use a unique Job Number.');
    return;
  }
  
  const jobData = {
    id: editingJobId || Date.now(),
    jobName,
    jobNumber,
    client,
    bcNumber,
    siteForeman
  };
  
  const existingIndex = savedJobs.findIndex(j => j.id === jobData.id);
  if (existingIndex >= 0) {
    savedJobs[existingIndex] = jobData;
  } else {
    savedJobs.push(jobData);
  }
  
  localStorage.setItem('siteNotesJobs', JSON.stringify(savedJobs));
  renderJobs();
  closeJobModal();
  alert('Job saved successfully!');
}

function showDeleteJobModal(id) {
  deleteJobId = id;
  document.getElementById('deleteJobModal').classList.add('active');
}

function closeDeleteJobModal() {
  document.getElementById('deleteJobModal').classList.remove('active');
  deleteJobId = null;
}

function confirmDeleteJob() {
  savedJobs = savedJobs.filter(j => j.id !== deleteJobId);
  localStorage.setItem('siteNotesJobs', JSON.stringify(savedJobs));
  closeDeleteJobModal();
  renderJobs();
}

// ============================================================================
// JOB DROPDOWN FUNCTIONS
// ============================================================================

function filterJobs() {
  const input = document.getElementById('jobName').value.toLowerCase();
  const dropdown = document.getElementById('jobDropdown');
  
  // Sort jobs alphabetically by name for dropdown
  const sortedJobs = [...savedJobs].sort((a, b) => 
    (a.jobName || '').localeCompare(b.jobName || '')
  );
  
  const filtered = sortedJobs.filter(j => 
    (j.jobName || '').toLowerCase().includes(input) ||
    (j.jobNumber || '').toLowerCase().includes(input)
  );
  
  let html = '';
  
  if (filtered.length > 0) {
    html = filtered.map(j => 
      `<div class="dropdown-item" onmousedown="selectJob(${j.id})">
        <strong>${j.jobName}</strong><br>
        <span style="font-size:12px;color:#666;">${j.jobNumber}</span>
      </div>`
    ).join('');
  } else if (input.length > 0) {
    html = '<div class="dropdown-item no-results">No jobs found</div>';
  }
  
  html += '<div class="dropdown-item add-new" onmousedown="showAddJobModal()">+ Add New Job</div>';
  
  dropdown.innerHTML = html;
  dropdown.classList.add('active');
}

function showJobDropdown() {
  filterJobs();
}

function hideJobDropdown() {
  setTimeout(() => {
    document.getElementById('jobDropdown').classList.remove('active');
  }, 200);
}

function selectJob(id) {
  const job = savedJobs.find(j => j.id === id);
  if (!job) return;
  
  document.getElementById('jobName').value = job.jobName || '';
  document.getElementById('jobNumber').value = job.jobNumber || '';
  document.getElementById('client').value = job.client || '';
  document.getElementById('bcNumber').value = job.bcNumber || '';
  document.getElementById('siteForeman').value = job.siteForeman || '';
  
  document.getElementById('jobDropdown').classList.remove('active');
}

async function exportPDF() {
  const data = getFormData();
  const { jsPDF } = window.jspdf;
  
  const pdf = new jsPDF("p", "mm", "a4");
  const pageW = 210;
  const pageH = 297;
  const margin = 15;

  // ---------------------------------------------------------------------------
  // Helper for section headings
  function sectionHeader(text, y) {
    pdf.setFontSize(14);
    pdf.setFont(undefined, "bold");
    pdf.text(text, margin, y);

    pdf.setDrawColor(200);
    pdf.line(margin, y + 2, margin + 60, y + 2);

    return y + 10;
  }

  // ---------------------------------------------------------------------------
  // 1. HEADER BAR
  let y = margin;

  // Logo right-aligned
  if (settings.logo) {
    try {
      const logoW = 35;
      const logoH = 18;
      const logoX = pageW - margin - logoW;
      pdf.addImage(settings.logo, "PNG", logoX, y, logoW, logoH);
    } catch (e) {
      console.log("Logo error", e);
    }
  }

  // Title left-aligned
  pdf.setFontSize(20);
  pdf.setFont(undefined, "bold");
  pdf.text("Site Observation Record", margin, y + 10);

  // Header divider
  pdf.setDrawColor(180);
  pdf.line(margin, y + 18, pageW - margin, y + 18);

  y += 28;

  // ---------------------------------------------------------------------------
  // 2. JOB DETAILS (two-column layout)
  pdf.setFontSize(11);
  pdf.setFont(undefined, "normal");

const leftCol = [
  `Job Name: ${data.jobName || "-"}`,
  `Client: ${data.client || "-"}`,
  `Site Foreman: ${data.siteForeman || "-"}`,
  `Technician: ${data.technician || "-"}`,
  `Reviewed:     `
];

const rightCol = [
  `Job Number: ${data.jobNumber || "-"}`,
  `BC Number: ${data.bcNumber || "-"}`,
  `Weather: ${data.weather || "-"}`,
  `Date: ${data.date}`,
  `Time: ${data.time}`
];

  leftCol.forEach((t, i) => {
    pdf.text(t, margin, y + i * 6);
  });

  rightCol.forEach((t, i) => {
    pdf.text(t, pageW / 2, y + i * 6);
  });

  y += 25;

  // ---------------------------------------------------------------------------
  // 3. SITE NOTES SECTION

  pdf.setDrawColor(180);
  pdf.line(margin, y, pageW - margin, y);
  y += 15;

  y = sectionHeader("Description of Observations and Testing", y);

  pdf.setFontSize(11);
  pdf.setFont(undefined, "normal");

  const noteLines = pdf.splitTextToSize(data.notes || "", pageW - margin * 2);

  noteLines.forEach((line) => {
    if (y > pageH - margin) {
      pdf.addPage();
      y = margin;
    }
    pdf.text(line, margin, y);
    y += 6; // readable spacing
  });

  // ---------------------------------------------------------------------------
  // 4. PHOTO GALLERY
  if (data.photos.length > 0) {
    // Load all images first
    const imagePromises = data.photos.map(photo => {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = photo.data;
      });
    });

    const loadedImages = await Promise.all(imagePromises);

    pdf.addPage();
    y = margin;

    y = sectionHeader("Site Photos", y);

    const imgMaxW = pageW - margin * 2;
    const imgMaxH = 100;

    for (let i = 0; i < data.photos.length; i++) {
      const photo = data.photos[i];
      const img = loadedImages[i];

      if (!img) continue; // Skip if image failed to load

      // Add new page for each pair of photos (after photo index 0, 2, 4)
      if (i > 0 && i % 2 === 0) {
        pdf.addPage();
        y = margin;
        y = sectionHeader("Site Photos (continued)", y);
      }

      // Calculate scaled dimensions
      const ratio = img.naturalWidth / img.naturalHeight;
      let w = imgMaxW;
      let h = w / ratio;

      if (h > imgMaxH) {
        h = imgMaxH;
        w = h * ratio;
      }

      // Center image horizontally on page
      const offsetX = (pageW - w) / 2;

      // Render image
      pdf.addImage(photo.data, "JPEG", offsetX, y, w, h);

      // Caption (wrapped)
      const caption = photo.caption || `Photo ${i + 1}`;
      const wrappedCaption = pdf.splitTextToSize(caption, pageW - margin * 2);

      pdf.setFontSize(10);
      pdf.setFont(undefined, "normal");
      pdf.text(wrappedCaption, margin, y + h + 8);

      // Move down for next photo (spacing between photos on same page)
      y += h + 20;
    }
  }

  // ---------------------------------------------------------------------------
  // 5. PAGE NUMBERS
  const pageCount = pdf.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    pdf.setPage(i);
    pdf.setFontSize(9);
    pdf.text(
      `Page ${i} of ${pageCount}`,
      pageW - margin - 20,
      pageH - 10
    );
  }

  // ---------------------------------------------------------------------------
  // 6. SAVE FILE
  const safeJob = data.jobNumber || "Job";
  const safeDate = data.date || "Date";
  pdf.save(`${safeJob}_${safeDate}_SiteVisit.pdf`);
}

function exportTXT() {
  const data = getFormData();
  let txt = `Site Observation Record
====================

Job Name: ${data.jobName}
Job Number: ${data.jobNumber}
Client: ${data.client}
BC Number: ${data.bcNumber}
Site Foreman: ${data.siteForeman}
Weather: ${data.weather}
Technician: ${data.technician}
Date: ${data.date}  Time: ${data.time}

--------------------

${data.notes}`;
  
  const blob = new Blob([txt], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `SiteNote_${data.jobNumber || 'export'}_${data.date}.txt`;
  a.click();
}

function exportDOC() {
  const data = getFormData();
  
let photoHTML = '';
  if (data.photos.length > 0) {
    photoHTML = '<br clear="all" style="page-break-before:always;"><h2>Site Photos</h2>';
    
    for (let i = 0; i < data.photos.length; i++) {
      const photo = data.photos[i];
      
      // Add page break after every 2 photos (except before the first photo)
      if (i > 0 && i % 2 === 0) {
        photoHTML += '<br clear="all" style="page-break-before:always;"><h2>Site Photos (continued)</h2>';
      }
      
      // Each photo in a table with fixed height
      photoHTML += '<table style="width:100%;border-collapse:collapse;margin-bottom:30px;"><tr>' +
        '<td style="width:100%;padding:10px;text-align:center;vertical-align:top;">' +
        '<img src="' + photo.data + '" height="360" style="max-width:100%;"><br>' +
        '<span style="font-size:10pt;color:#666;">' + (photo.caption || 'Photo ' + (i + 1)) + '</span>' +
        '</td></tr></table>';
    }
  }

  const notesFormatted = data.notes.replace(/\n/g, '<br>');

  const doc = '<!DOCTYPE html>' +
'<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">' +
'<head>' +
'<meta charset="UTF-8">' +
'<style>' +
'@page { margin: 2cm; }' +
'body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.4; }' +
'h1 { font-size: 18pt; margin-bottom: 12pt; }' +
'h2 { font-size: 14pt; margin-top: 18pt; margin-bottom: 12pt; }' +
'.header-table { width: 100%; margin-bottom: 12pt; }' +
'.logo-cell { text-align: right; }' +
'.details td { padding: 3pt 6pt; vertical-align: top; }' +
'.label { font-weight: bold; }' +
'.notes { white-space: pre-wrap; margin-top: 12pt; }' +
'.divider { border-top: 1px solid #999; margin: 12pt 0; }' +
'</style>' +
'</head>' +
'<body>' +
'<table class="header-table"><tr>' +
'<td><h1>Site Observation Record</h1></td>' +
(settings.logo ? '<td class="logo-cell"><img src="' + settings.logo + '" width="150" height="60" style="object-fit:contain;"></td>' : '') +
'</tr></table>' +
'<table class="details" style="width:100%;">' +
'<tr><td class="label" style="width:15%;">Job Name:</td><td style="width:35%;">' + (data.jobName || '-') + '</td><td class="label" style="width:15%;">Job Number:</td><td style="width:35%;">' + (data.jobNumber || '-') + '</td></tr>' +
'<tr><td class="label">Client:</td><td>' + (data.client || '-') + '</td><td class="label">BC Number:</td><td>' + (data.bcNumber || '-') + '</td></tr>' +
'<tr><td class="label">Site Foreman:</td><td>' + (data.siteForeman || '-') + '</td><td class="label">Weather:</td><td>' + (data.weather || '-') + '</td></tr>' +
'<tr><td class="label">Technician:</td><td>' + (data.technician || '-') + '</td><td class="label">Date:</td><td>' + (data.date || '-') + '</td></tr>' +
'<tr><td class="label">Reviewed:</td><td colspan="1"></td><td class="label">Time:</td><td>' + (data.time || '-') + '</td></tr>' +
'</table>' +
'<div class="divider"></div>' +
'<h2>Description of Observations and Testing</h2>' +
'<div class="notes">' + notesFormatted + '</div>' +
photoHTML +
'</body></html>';

  const blob = new Blob(['\ufeff' + doc], { type: 'application/msword' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'SiteNote_' + (data.jobNumber || 'export') + '_' + (data.date || 'undated') + '.doc';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function exportAllData() {
  const exportData = {
    version: 2,
    exportDate: new Date().toISOString(),
    settings: settings,
    savedNotes: savedNotes,
    savedJobs: savedJobs
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'SiteNotes_Backup_' + new Date().toISOString().split('T')[0] + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importAllData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importData = JSON.parse(e.target.result);
      
      if (!importData.settings && !importData.savedNotes && !importData.savedJobs) {
        alert('Invalid backup file. Please select a valid Site Notes backup.');
        return;
      }
      
      const noteCount = importData.savedNotes ? importData.savedNotes.length : 0;
      const jobCount = importData.savedJobs ? importData.savedJobs.length : 0;
      const confirmMsg = 'This will replace all your current data with:\n\n' +
        '‚Ä¢ ' + noteCount + ' saved note(s)\n' +
        '‚Ä¢ ' + jobCount + ' saved job(s)\n' +
        '‚Ä¢ All settings (technician name, logo, templates)\n\n' +
        'Your current data will be lost. Continue?';
      
      if (!confirm(confirmMsg)) {
        event.target.value = '';
        return;
      }
      
      if (importData.settings) {
        settings = importData.settings;
        localStorage.setItem('siteNotesSettings', JSON.stringify(settings));
      }
      
      if (importData.savedNotes) {
        savedNotes = importData.savedNotes;
        localStorage.setItem('siteNotesSaved', JSON.stringify(savedNotes));
      }
      
      if (importData.savedJobs) {
        savedJobs = importData.savedJobs;
        localStorage.setItem('siteNotesJobs', JSON.stringify(savedJobs));
      }
      
      // Refresh the UI
      document.getElementById('settingsTechnician').value = settings.technician || '';
      if (settings.logo) {
        document.getElementById('logoPreview').src = settings.logo;
        document.getElementById('logoPreview').style.display = 'block';
      } else {
        document.getElementById('logoPreview').style.display = 'none';
      }
      renderTemplateInputs();
      renderCheckboxes();
      renderSavedNotes();
      renderJobs();
      document.getElementById('technician').value = settings.technician || '';
      
      alert('Data imported successfully! ' + noteCount + ' note(s) and ' + jobCount + ' job(s) restored.');
      
    } catch (err) {
      alert('Error reading backup file: ' + err.message);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

init();

</script>
</body>
</html>
