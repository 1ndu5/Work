<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Site Notes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
.container { max-width: 900px; margin: 0 auto; padding: 16px; }
h1 { font-size: 1.5rem; margin-bottom: 16px; color: #333; }
.tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.tab-btn { padding: 10px 20px; border: none; background: #e0e0e0; cursor: pointer; border-radius: 6px; font-size: 14px; }
.tab-btn.active { background: #2196F3; color: white; }
.tab-content { display: none; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.tab-content.active { display: block; }
.form-group { margin-bottom: 16px; }
.form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #555; }
.form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
.form-group textarea { min-height: 200px; resize: vertical; font-family: inherit; }
.form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
.checkbox-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-bottom: 16px; }
.checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f9f9f9; border-radius: 6px; }
.checkbox-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
.checkbox-item label { cursor: pointer; font-size: 14px; flex: 1; }
.photo-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px; }
.photo-slot { border: 2px dashed #ddd; border-radius: 8px; padding: 16px; text-align: center; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
.photo-slot.has-photo { border-style: solid; border-color: #2196F3; }
.photo-slot img { max-width: 100%; max-height: 200px; object-fit: contain; margin-bottom: 10px; border-radius: 4px; }
.photo-slot input[type="file"] { display: none; }
.photo-slot .add-btn { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; }
.photo-slot .remove-btn { padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 8px; }
.photo-slot input[type="text"] { margin-top: 10px; }
.btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
.btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
.btn-primary { background: #2196F3; color: white; }
.btn-success { background: #4CAF50; color: white; }
.btn-secondary { background: #757575; color: white; }
.btn-danger { background: #f44336; color: white; }
.settings-section { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #eee; }
.settings-section h3 { margin-bottom: 16px; color: #333; }
.template-item { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
.template-item input { flex: 1; }
.template-item span { min-width: 30px; color: #666; }
.logo-preview { max-width: 200px; max-height: 100px; margin-top: 10px; }
table { width: 100%; border-collapse: collapse; margin-top: 16px; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
th { background: #f5f5f5; font-weight: 600; }
tr:hover { background: #f9f9f9; }
.clickable { cursor: pointer; color: #2196F3; }
.note-preview { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #666; font-size: 13px; }
.action-btns { display: flex; gap: 6px; }
.action-btns .btn { padding: 6px 12px; font-size: 12px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
.modal.active { display: flex; }
.modal-content { background: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%; }
.modal-content h3 { margin-bottom: 16px; }
.modal-btns { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
@media (max-width: 600px) {
  .form-row { grid-template-columns: 1fr; }
  .checkbox-grid { grid-template-columns: 1fr; }
  .photo-grid { grid-template-columns: 1fr; }
  .tabs { flex-direction: column; }
  .tab-btn { width: 100%; }
  table { font-size: 13px; }
  th, td { padding: 8px 4px; }
}
</style>
</head>
<body>
<div class="container">
<h1>üìã Site Notes</h1>
<div class="tabs">
<button class="tab-btn active" onclick="showTab('new')">New Note</button>
<button class="tab-btn" onclick="showTab('saved')">Saved Notes</button>
<button class="tab-btn" onclick="showTab('settings')">Settings</button>
</div>

<div id="new" class="tab-content active">
<div class="form-row">
<div class="form-group"><label>Job Name</label><input type="text" id="jobName"></div>
<div class="form-group"><label>Job Number</label><input type="text" id="jobNumber"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Technician</label><input type="text" id="technician"></div>
<div class="form-group"><label>Date</label><input type="date" id="noteDate"></div>
<div class="form-group"><label>Time</label><input type="time" id="noteTime"></div>
</div>

<h3 style="margin: 20px 0 12px;">Quick Add Items</h3>
<div class="checkbox-grid" id="checkboxGrid"></div>

<div class="form-group">
<label>Site Notes</label>
<textarea id="siteNotes" placeholder="Enter your site notes here..."></textarea>
</div>

<h3 style="margin: 20px 0 12px;">Photos (max 6)</h3>
<div class="photo-grid" id="photoGrid"></div>

<div class="btn-group">
<button class="btn btn-success" onclick="saveNote()">üíæ Save Note</button>
<button class="btn btn-primary" onclick="exportPDF()">üìÑ Export PDF</button>
<button class="btn btn-secondary" onclick="exportRTF()">üìù Export RTF</button>
<button class="btn btn-secondary" onclick="exportHTML()">üåê Export HTML</button>
<button class="btn btn-danger" onclick="clearForm()">üóëÔ∏è Clear</button>
</div>
</div>

<div id="saved" class="tab-content">
<h2 style="margin-bottom: 16px;">Saved Notes</h2>
<div id="savedNotesTable"></div>
</div>

<div id="settings" class="tab-content">
<div class="settings-section">
<h3>Technician Name</h3>
<div class="form-group">
<input type="text" id="settingsTechnician" placeholder="Enter default technician name" onchange="saveSettings()">
</div>
</div>

<div class="settings-section">
<h3>Company Logo</h3>
<div class="form-group">
<input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
<img id="logoPreview" class="logo-preview" style="display:none;">
<br><button class="btn btn-danger" style="margin-top:10px;" onclick="removeLogo()">Remove Logo</button>
</div>
</div>

<div class="settings-section">
<h3>Quick Add Templates</h3>
<div id="templateInputs"></div>
<button class="btn btn-secondary" style="margin-top:10px;" onclick="saveSettings()">Save Templates</button>
</div>
</div>
</div>

<div class="modal" id="deleteModal">
<div class="modal-content">
<h3>Delete Note?</h3>
<p>Are you sure you want to delete this note? This cannot be undone.</p>
<div class="modal-btns">
<button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
<button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
</div>
</div>
</div>

<script>
const defaultTemplates = [
  { title: "Site Stripping", text: "Observed topsoil stripping across approximate area shown on attached site plan. Topsoil had adequately been stripped with native soils exposed" },
  { title: "Proof Roll (passed)", text: "Observed proof roll of the area shown on the attached site plan with a XX ton smooth drum roller.  No obvious deflections were visible.  Vane shear strengths measured across the area ranged between XX and XX kPa.  Advised contractor that basecourse could be placed across this area." },
  { title: "Proof Roll (failed)", text: "Observed proof roll of the area shown on the attached site plan with a XX ton smooth drum roller.  Weaving of the ground was identified in the areas shown on site plan.  Trial pits were carried out in these areas to a depth of XX m which identified ..." },
  { title: "Shallow Foundations", text: "Observed strip and pad foundation excavations along the grid lines marked on the attached site plan.  All excavations were a minimum of XXX mm deep. Shear vanes in the base ranged between XX and XX kPa which meet the design assumptions." },
  { title: "Piled Foundations", text: "Observed bored pile excavations as shown on attached site plan.  Piles were XX m deep and XXX mm diameter.  Shear vanes in the side of the piles ranged between XX and XX kPa and in the base ranged between XX and XX kPa which meet the design assumptions." },
  { title: "Clay Fill Testing", text: "Approximately XXX mm of clay has been placed across the fill area shown on the attached site plan since last visit.  Shear vane testing across the fill area ranged from XX to XX kPa.  XX air voids samples were collected from locations shown on attached site plan." },
  { title: "Clegg Testing", text: "Approximately XXX mm of hardfill has been placed across the area shown on the attached site plan since last visit.  Clegg Hammer testing was carried out which returned CIV values ranging between XX and XX which meet the required specification." },
  { title: "Retaining Walls", text: "In-situ testing (DCP/Vane shear) completed at designated locations." },
  { title: "Hardfill NDM Testing", text: "Approximately XXX mm of hardfill has been placed across the area shown on the attached site plan since last visit. XXX NDM tests were carried out in the locations shown on the site plan.  These returned results ranging between XX and XX % of MDD which meet the required specification." },
  { title: "Follow up with CAN", text: "Discussed potential remedial actions with contractor.  Our recommendations will be issued in a seperate CAN." }
];

let settings = JSON.parse(localStorage.getItem('siteNotesSettings')) || {
  technician: '',
  logo: null,
  templates: [...defaultTemplates]
};
let savedNotes = JSON.parse(localStorage.getItem('siteNotesSaved')) || [];
let photos = [null, null, null, null, null, null];
let editingNoteId = null;
let deleteNoteId = null;

function init() {
  document.getElementById('settingsTechnician').value = settings.technician;
  if (settings.logo) {
    document.getElementById('logoPreview').src = settings.logo;
    document.getElementById('logoPreview').style.display = 'block';
  }
  renderTemplateInputs();
  renderCheckboxes();
  renderPhotoSlots();
  renderSavedNotes();
  setDefaultDateTime();
  document.getElementById('technician').value = settings.technician;
}

function setDefaultDateTime() {
  const now = new Date();
  document.getElementById('noteDate').value = now.toISOString().split('T')[0];
  document.getElementById('noteTime').value = now.toTimeString().slice(0,5);
}

function showTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
  document.getElementById(tab).classList.add('active');
  if (tab === 'saved') renderSavedNotes();
}

function renderTemplateInputs() {
  const container = document.getElementById('templateInputs');
  container.innerHTML = settings.templates.map((t, i) => `
    <div class="template-item" style="flex-direction:column;align-items:stretch;margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:6px;">
      <div style="display:flex;gap:10px;margin-bottom:8px;">
        <span style="min-width:30px;">${i + 1}.</span>
        <input type="text" value="${t.title}" placeholder="Title" onchange="updateTemplate(${i}, 'title', this.value)">
      </div>
      <textarea style="width:100%;min-height:60px;margin-left:40px;width:calc(100% - 40px);" placeholder="Standard text..." onchange="updateTemplate(${i}, 'text', this.value)">${t.text}</textarea>
    </div>
  `).join('');
}

function updateTemplate(index, field, value) {
  settings.templates[index][field] = value;
}

function renderCheckboxes() {
  const container = document.getElementById('checkboxGrid');
  container.innerHTML = settings.templates.map((t, i) => `
    <div class="checkbox-item">
      <input type="checkbox" id="cb${i}" onchange="handleCheckbox(${i}, this.checked)">
      <label for="cb${i}">${t.title}</label>
    </div>
  `).join('');
}

function handleCheckbox(index, checked) {
  if (checked) {
    const textarea = document.getElementById('siteNotes');
    const currentText = textarea.value;
    const newText = settings.templates[index].text;
    textarea.value = currentText ? currentText + '\n\n' + newText : newText;
  }
}

function renderPhotoSlots() {
  const container = document.getElementById('photoGrid');
  container.innerHTML = photos.map((p, i) => `
    <div class="photo-slot ${p ? 'has-photo' : ''}" id="slot${i}">
      ${p ? `<img src="${p.data}" alt="Photo ${i + 1}">` : ''}
      <input type="file" id="file${i}" accept="image/*" onchange="handlePhoto(${i}, event)">
      ${p ? '' : `<button class="add-btn" onclick="document.getElementById('file${i}').click()">+ Add Photo</button>`}
      ${p ? `<input type="text" placeholder="Caption..." value="${p.caption || ''}" onchange="updateCaption(${i}, this.value)">` : ''}
      ${p ? `<button class="remove-btn" onclick="removePhoto(${i})">Remove</button>` : ''}
    </div>
  `).join('');
}

function handlePhoto(index, event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > 1200) { h = h * (1200 / w); w = 1200; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      photos[index] = { data: canvas.toDataURL('image/jpeg', 0.85), caption: '' };
      renderPhotoSlots();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function updateCaption(index, caption) {
  if (photos[index]) photos[index].caption = caption;
}

function removePhoto(index) {
  photos[index] = null;
  renderPhotoSlots();
}

function handleLogoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 500000) { alert('Logo must be under 500KB'); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    settings.logo = e.target.result;
    document.getElementById('logoPreview').src = settings.logo;
    document.getElementById('logoPreview').style.display = 'block';
    saveSettings();
  };
  reader.readAsDataURL(file);
}

function removeLogo() {
  settings.logo = null;
  document.getElementById('logoPreview').style.display = 'none';
  document.getElementById('logoInput').value = '';
  saveSettings();
}

function saveSettings() {
  settings.technician = document.getElementById('settingsTechnician').value;
  // Read all template values from the inputs
  document.querySelectorAll('#templateInputs .template-item').forEach((item, i) => {
    const titleInput = item.querySelector('input[type="text"]');
    const textArea = item.querySelector('textarea');
    settings.templates[i] = {
      title: titleInput.value,
      text: textArea.value
    };
  });
  localStorage.setItem('siteNotesSettings', JSON.stringify(settings));
  renderCheckboxes();
}

function getFormData() {
  return {
    id: editingNoteId || Date.now(),
    jobName: document.getElementById('jobName').value,
    jobNumber: document.getElementById('jobNumber').value,
    technician: document.getElementById('technician').value,
    date: document.getElementById('noteDate').value,
    time: document.getElementById('noteTime').value,
    notes: document.getElementById('siteNotes').value,
    photos: photos.filter(p => p !== null)
  };
}

function saveNote() {
  const data = getFormData();
  if (!data.jobName && !data.notes) { alert('Please add some content before saving.'); return; }
  const existingIndex = savedNotes.findIndex(n => n.id === data.id);
  if (existingIndex >= 0) savedNotes[existingIndex] = data;
  else savedNotes.unshift(data);
  localStorage.setItem('siteNotesSaved', JSON.stringify(savedNotes));
  alert('Note saved successfully!');
  editingNoteId = data.id;
}

function renderSavedNotes() {
  const container = document.getElementById('savedNotesTable');
  if (savedNotes.length === 0) {
    container.innerHTML = '<p style="color:#666;">No saved notes yet.</p>';
    return;
  }
  container.innerHTML = `<table>
    <thead><tr><th>Date</th><th>Job Number</th><th>Job Name</th><th>Preview</th><th>Actions</th></tr></thead>
    <tbody>${savedNotes.map(n => `
      <tr>
        <td>${n.date || '-'}</td>
        <td>${n.jobNumber || '-'}</td>
        <td class="clickable" onclick="loadNote(${n.id})">${n.jobName || '-'}</td>
        <td class="note-preview">${n.notes ? n.notes.substring(0, 50) : '-'}</td>
        <td class="action-btns">
          <button class="btn btn-primary" onclick="loadNote(${n.id})">Edit</button>
          <button class="btn btn-danger" onclick="showDeleteModal(${n.id})">Delete</button>
        </td>
      </tr>
    `).join('')}</tbody>
  </table>`;
}

function loadNote(id) {
  const note = savedNotes.find(n => n.id === id);
  if (!note) return;
  editingNoteId = id;
  document.getElementById('jobName').value = note.jobName || '';
  document.getElementById('jobNumber').value = note.jobNumber || '';
  document.getElementById('technician').value = note.technician || '';
  document.getElementById('noteDate').value = note.date || '';
  document.getElementById('noteTime').value = note.time || '';
  document.getElementById('siteNotes').value = note.notes || '';
  photos = [null, null, null, null, null, null];
  (note.photos || []).forEach((p, i) => { if (i < 6) photos[i] = p; });
  renderPhotoSlots();
  showTab('new');
}

function showDeleteModal(id) {
  deleteNoteId = id;
  document.getElementById('deleteModal').classList.add('active');
}

function closeModal() {
  document.getElementById('deleteModal').classList.remove('active');
  deleteNoteId = null;
}

function confirmDelete() {
  savedNotes = savedNotes.filter(n => n.id !== deleteNoteId);
  localStorage.setItem('siteNotesSaved', JSON.stringify(savedNotes));
  closeModal();
  renderSavedNotes();
}

function clearForm() {
  editingNoteId = null;
  document.getElementById('jobName').value = '';
  document.getElementById('jobNumber').value = '';
  document.getElementById('technician').value = settings.technician;
  document.getElementById('siteNotes').value = '';
  photos = [null, null, null, null, null, null];
  document.querySelectorAll('.checkbox-item input').forEach(cb => cb.checked = false);
  renderPhotoSlots();
  setDefaultDateTime();
}

async function exportPDF() {
  const data = getFormData();
  const { jsPDF } = window.jspdf;
  
  const pdf = new jsPDF("p", "mm", "a4");
  const pageW = 210;
  const pageH = 297;
  const margin = 15;

  // ---------------------------------------------------------------------------
  // Helper for section headings
  function sectionHeader(text, y) {
    pdf.setFontSize(14);
    pdf.setFont(undefined, "bold");
    pdf.text(text, margin, y);

    pdf.setDrawColor(200);
    pdf.line(margin, y + 2, margin + 60, y + 2);

    return y + 10;
  }

  // ---------------------------------------------------------------------------
  // 1. HEADER BAR
  let y = margin;

  // Logo right-aligned
  if (settings.logo) {
    try {
      const logoW = 35;
      const logoH = 18;
      const logoX = pageW - margin - logoW;
      pdf.addImage(settings.logo, "PNG", logoX, y, logoW, logoH);
    } catch (e) {
      console.log("Logo error", e);
    }
  }

  // Title left-aligned
  pdf.setFontSize(20);
  pdf.setFont(undefined, "bold");
  pdf.text("Site Note", margin, y + 10);

  // Header divider
  pdf.setDrawColor(180);
  pdf.line(margin, y + 18, pageW - margin, y + 18);

  y += 28;

  // ---------------------------------------------------------------------------
  // 2. JOB DETAILS (two-column layout)
  pdf.setFontSize(11);
  pdf.setFont(undefined, "normal");

  const leftCol = [
    `Job Name: ${data.jobName || "-"}`,
    `Technician: ${data.technician || "-"}`
  ];

  const rightCol = [
    `Job Number: ${data.jobNumber || "-"}`,
    `Date: ${data.date}   Time: ${data.time}`
  ];

  leftCol.forEach((t, i) => {
    pdf.text(t, margin, y + i * 6);
  });

  rightCol.forEach((t, i) => {
    pdf.text(t, pageW / 2, y + i * 6);
  });

  y += 18;

  // ---------------------------------------------------------------------------
  // 3. SITE NOTES SECTION
  y = sectionHeader("Site Notes", y);

  pdf.setFontSize(11);
  pdf.setFont(undefined, "normal");

  const noteLines = pdf.splitTextToSize(data.notes || "", pageW - margin * 2);

  noteLines.forEach((line) => {
    if (y > pageH - margin) {
      pdf.addPage();
      y = margin;
    }
    pdf.text(line, margin, y);
    y += 6; // readable spacing
  });

  // ---------------------------------------------------------------------------
  // 4. PHOTO GALLERY
  if (data.photos.length > 0) {
    pdf.addPage();
    y = margin;

    y = sectionHeader("Photo Gallery", y);

    const cols = 2;
    const colGap = 10;
    const cellW = (pageW - margin * 2 - colGap) / 2;

    const imgMaxW = cellW;
    const imgMaxH = 55;

    let col = 0;

    for (let i = 0; i < data.photos.length; i++) {
      const photo = data.photos[i];
      const x = margin + col * (cellW + colGap);

      // If starting a new row would exceed page, add new page
      if (col === 0 && y + imgMaxH + 25 > pageH - margin) {
        pdf.addPage();
        y = margin;
      }

      // Load image to read dimensions
      const img = new Image();
      img.src = photo.data;

      // Calculate scaled dimensions
      const ratio = img.naturalWidth / img.naturalHeight;
      let w = imgMaxW;
      let h = w / ratio;

      if (h > imgMaxH) {
        h = imgMaxH;
        w = h * ratio;
      }

      // Center image horizontally within its cell
      const offsetX = (cellW - w) / 2;

      // Render image
      pdf.addImage(photo.data, "JPEG", x + offsetX, y, w, h);

      // Caption (wrapped)
      const caption = photo.caption || `Photo ${i + 1}`;
      const wrappedCaption = pdf.splitTextToSize(caption, cellW);

      pdf.setFontSize(9);
      pdf.setFont(undefined, "normal");
      pdf.text(wrappedCaption, x, y + h + 6);

      // Move to next column
      col++;

      if (col === cols) {
        col = 0;
        y += imgMaxH + 22; // row height
      }
    }
  }

  // ---------------------------------------------------------------------------
  // 5. PAGE NUMBERS
  const pageCount = pdf.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++) {
    pdf.setPage(i);
    pdf.setFontSize(9);
    pdf.text(
      `Page ${i} of ${pageCount}`,
      pageW - margin - 20,
      pageH - 10
    );
  }

  // ---------------------------------------------------------------------------
  // 6. SAVE FILE
  const safeJob = data.jobNumber || "Job";
  const safeDate = data.date || "Date";
  pdf.save(`${safeJob}_${safeDate}_SiteVisit.pdf`);
}


function exportRTF() {
  const data = getFormData();
  let rtf = `{\\rtf1\\ansi\\deff0 {\\fonttbl{\\f0 Arial;}}
\\f0\\fs24\\b Site Note\\b0\\par\\par
\\fs22 Job Name: ${data.jobName}\\par
Job Number: ${data.jobNumber}\\par
Technician: ${data.technician}\\par
Date: ${data.date}  Time: ${data.time}\\par
\\par\\line\\par
\\fs20 ${data.notes.replace(/\n/g, '\\par ')}\\par`;
  
  if (data.photos.length > 0) {
    rtf += `\\par\\page\\fs24\\b Photo Gallery\\b0\\par\\par`;
    data.photos.forEach((p, i) => {
      rtf += `\\fs20 Photo ${i + 1}: ${p.caption || 'No caption'}\\par\\par`;
    });
    rtf += `\\par\\fs18\\i Note: Photos must be added manually to this RTF document or use PDF/HTML export for embedded images.\\i0\\par`;
  }
  rtf += '}';
  
  const blob = new Blob([rtf], { type: 'application/rtf' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `SiteNote_${data.jobNumber || 'export'}_${data.date}.rtf`;
  a.click();
}

function exportHTML() {
  const data = getFormData();
  let photoHTML = '';
  if (data.photos.length > 0) {
    photoHTML = `<div style="page-break-before:always;"><h2>Photo Gallery</h2>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
    ${data.photos.map((p, i) => `<div style="text-align:center;">
      <img src="${p.data}" style="max-width:100%;height:auto;border:1px solid #ddd;border-radius:4px;">
      <p style="margin-top:8px;color:#666;">${p.caption || `Photo ${i + 1}`}</p>
    </div>`).join('')}</div></div>`;
  }
  
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Site Note - ${data.jobNumber}</title>
<style>body{font-family:Arial,sans-serif;max-width:800px;margin:0 auto;padding:20px;}
.header{border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:20px;}
.logo{max-height:60px;margin-bottom:10px;} .details{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.notes{white-space:pre-wrap;line-height:1.6;} @media print{body{padding:0;}}</style></head>
<body><div class="header">${settings.logo ? `<img src="${settings.logo}" class="logo">` : ''}
<h1>Site Note</h1><div class="details">
<p><strong>Job Name:</strong> ${data.jobName}</p><p><strong>Job Number:</strong> ${data.jobNumber}</p>
<p><strong>Technician:</strong> ${data.technician}</p><p><strong>Date:</strong> ${data.date} <strong>Time:</strong> ${data.time}</p>
</div></div><div class="notes">${data.notes}</div>${photoHTML}</body></html>`;
  
  const blob = new Blob([html], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `SiteNote_${data.jobNumber || 'export'}_${data.date}.html`;
  a.click();
}

init();
</script>
</body>
</html>
